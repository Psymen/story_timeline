var apikey="_Tgxq2pPzSNSlrvt2fapH0YW1bc5okjFhvj5ortDJas",projectList=[{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/25109541415",refShort:"/project/25109541415",_refObjectName:"Smart Account + User Management"},{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/25109543613",refShort:"/project/25109543613",_refObjectName:"Usage"},{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/25109543887",refShort:"/project/25109543887",_refObjectName:"Fulfillment"},{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/25110404377",refShort:"/project/25110404377",_refObjectName:"ELA"},{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/29236251005",refShort:"/project/29236251005",_refObjectName:"Software Convergence"},{_ref:"https://rally1.rallydev.com/slm/webservice/v2.0/project/29236391259",refShort:"/project/29236391259",_refObjectName:"New Classic & Smart License Capabilities"}],myApp=angular.module("myApp",[]);myApp.controller("MainCtrl",["$scope","$http","$q","$anchorScroll","$location",function(e,t,r,i,a){e.scrollTo=function(e){a.hash(e),i()},e.hlsloadingfinished=!1,e.epicloadingfinished=!1,e.usloadingfinished=!1,e.hlsString="PortfolioItem/HighLevelScope",e.epicString="PortfolioItem/Epic",e.userStoryString="HierarchicalRequirement";var l={};l.hlsData={},l.epicData={},l.usData={},l.iterationData={},l.hlsData.Results=[],l.epicData.Results=[],l.usData.Results=[],l.iterationData.Results=[],m=l,s=e,e.queryArtifactsAndStore=function(i,a,n){if(!n)var n=r.defer();var s=a||1,o="https://rally1.rallydev.com/slm/webservice/v2.0/"+i,c=["FormattedID","ObjectID","Name","ScheduleState","State","PreliminaryEstimate","ActualStartDate","Children","Iteration","Tags","Parent","Project","Description","Release","Epic","PlannedStartDate","PlannedEndDate","StartDate","EndDate","PlanEstimate","Ready"],u={params:{workspace:"https://rally1.rallydev.com/slm/webservice/v2.0/workspace/19718879730",query:"",fetch:c.toString(),start:s,pagesize:200,key:"ae437b95-d241-4320-ad81-bd0681947c89"},headers:{zsessionid:apikey}};return t.get(o,u).success(function(t,r,o,c){if(i===e.hlsString?(l.hlsData.Results=l.hlsData.Results.concat(t.QueryResult.Results),e.loadingScreenDetails.push("[Success] : Loading "+i)):i===e.epicString?(l.epicData.Results=l.epicData.Results.concat(t.QueryResult.Results),e.loadingScreenDetails.push("[Success] : Loading "+i)):i===e.userStoryString?(l.usData.Results=l.usData.Results.concat(t.QueryResult.Results),e.loadingScreenDetails.push("[Success] : Loading "+i+" ("+s+")")):"iteration"===i&&(l.iterationData.Results=l.iterationData.Results.concat(t.QueryResult.Results)),t.QueryResult.Results.length==c.params.pagesize)e.loadingProgress+=Math.floor(60*(c.params.pagesize/t.QueryResult.TotalResultCount)),e.queryArtifactsAndStore(i,(a||0)+c.params.pagesize,n);else{var u=null;i===e.hlsString?(e.hlsloadingfinished=!0,u=l.hlsData,e.loadingProgress+=20):i===e.epicString?(e.epicloadingfinished=!0,u=l.epicData,e.loadingProgress+=20):i===e.userStoryString?(e.usloadingfinished=!0,u=l.usData):u=t,n.resolve(u)}}).error(function(t,r,i,a){return e.loadingScreenDetails.push("[Error] : Loading Data Failed"),n.reject()}),n.promise};var n=function(e){var t="https://us1.rallydev.com/#/",r=e._type,i=e.ObjectID,a=e.Project.ObjectID,l="";return l="PortfolioItem/HighLevelScope"===r?"/detail/portfolioitem/highlevelscope/"+i:"PortfolioItem/Epic"===r?"/detail/portfolioitem/epic/"+i:"/detail/userstory/"+i,t+a+l};e.displayLoading=function(t){t?$("#loadingModal").modal("show"):($("#loadingModal").modal("hide"),e.loadingProgress=0,e.loadingScreenDetails=[])},e.init=function(){e.loadingProgress=0,e.loadingScreenDetails=[],$("#loadingModal").modal({keyboard:!1}),e.displayLoading(!0),e.projects=projectList,r.all([e.queryArtifactsAndStore(e.hlsString),e.queryArtifactsAndStore(e.epicString),e.queryArtifactsAndStore(e.userStoryString),e.queryArtifactsAndStore("iteration"),e.queryArtifactsAndStore("Project")]).then(function(t){e.sprint=e.findSprintRange(l.iterationData.Results),e.initFilters(),e.constructTree(),e.constructProjectTree(),e.displayLoading(!1)},function(t){e.loadingScreenDetails.push("[Error] : Something went wrong with initial data load, please restart")})},e.constructProjectTree=function(){e.projectTree=[];for(var t=0;t<projectList.length;t+=1){{projectList[t].toString}e.projectTree.push({project:projectList[t]._refObjectName,hlsBacklog:_.filter(l.hlsData.Results,function(r){return e.filter.hlsBacklog(r,e.projects[t])}),hlsIP:_.filter(l.hlsData.Results,function(r){return e.filter.hlsIP(r,e.projects[t])}),hlsDone:_.filter(l.hlsData.Results,function(r){return e.filter.hlsDone(r,e.projects[t])}),epicDefinitionIP:_.filter(l.epicData.Results,function(r){return e.filter.epicDefinitionIP(r,e.projects[t])}),epicDefinitionCompleted:_.filter(l.epicData.Results,function(r){return e.filter.epicDefinitionCompleted(r,e.projects[t])}),epicDeliveryIP:_.filter(l.epicData.Results,function(r){return e.filter.epicDeliveryIP(r,e.projects[t])}),epicDeliveryCompleted:_.filter(l.epicData.Results,function(r){return e.filter.epicDeliveryCompleted(r,e.projects[t])}),storyDefinitionIP:_.filter(l.usData.Results,function(r){return e.filter.storyDefinitionIP(r,e.projects[t])}),storyDefinitionDone:_.filter(l.usData.Results,function(r){return e.filter.storyDefinitionDone(r,e.projects[t])}),storyRPS2:_.filter(l.usData.Results,function(r){return e.filter.storyRPS2(r,e.projects[t])}),storyRPS1:_.filter(l.usData.Results,function(r){return e.filter.storyRPS1(r,e.projects[t])}),deliveryDataBacklog:_.filter(l.usData.Results,function(r){return e.filter.deliveryBacklog(r,e.projects[t])}),deliveryDataIP:_.filter(l.usData.Results,function(r){return e.filter.deliveryInProgress(r,e.projects[t])}),deliveryDataCompleted:_.filter(l.usData.Results,function(r){return e.filter.deliveryCompleted(r,e.projects[t])}),deliveryDataAccepted:_.filter(l.usData.Results,function(r){return e.filter.deliveryAccepted(r,e.projects[t])}),_refObjectName:projectList[t]._refObjectName})}},e.findSprintRange=function(t){e.s=moment(),e.s1=moment().add(3,"w"),e.s2=moment().add(6,"w");var r=[[],[],[]];return angular.forEach(t,function(t,i){e.s.isAfter(t.StartDate)&&e.s.isBefore(t.EndDate)?r[0].push(t.Name):e.s1.isAfter(t.StartDate)&&e.s1.isBefore(t.EndDate)?r[1].push(t.Name):e.s2.isAfter(t.StartDate)&&e.s2.isBefore(t.EndDate)&&r[2].push(t.Name)}),r},e.currentTrack="none",e.EpicUserStoryList=[],e.constructTree=function(){for(var t=0,r=l.hlsData.Results.length;r>t;t+=1){var i=l.hlsData.Results[t];i.track=i._refObjectUUID,i.detailsPage=n(i)}for(var t=0,r=l.epicData.Results.length;r>t;t+=1){var a=l.epicData.Results[t];a.track=null!==a.Parent?a.Parent._refObjectUUID:null,a.detailsPage=n(a)}for(var t=0,r=l.usData.Results.length;r>t;t+=1){var s=l.usData.Results[t];if("EPIC"===s.Name.substring(0,4).toUpperCase()&&s.Epic&&e.EpicUserStoryList.push(s),null!==s.Epic)s.track=_.where(l.epicData.Results,{_refObjectUUID:s.Epic._refObjectUUID})[0].track;else if(null!==s.Parent){var o=_.where(l.usData.Results,{_refObjectUUID:s.Parent._refObjectUUID})[0];s.track=null!==o.Epic?_.where(l.epicData.Results,{_refObjectUUID:o.Epic._refObjectUUID})[0].track:null}else s.track=null;s.detailsPage=n(s)}},e.highlighTrack=function(t){e.currentTrack=t==e.currentTrack?"none":t},e.initFilters=function(){e.filter={},e.filter.hlsCOMMON=function(e,t){return e&&t&&e.Project?e.Project._refObjectName!==t._refObjectName?!1:!0:!1},e.filter.hlsBacklog=function(t,r){var i=!1;return t.State&&"Define"!==t.State.Name||(i=!0),t.highlight=!1,(!t.PlannedStartDate||moment().isAfter(t.PlannedStartDate))&&(t.highlight=!0),i&&e.filter.hlsCOMMON(t,r)},e.filter.hlsIP=function(t,r){var i=!1;return t.State&&"InProgress"===t.State.Name&&(i=!0),t.highlight=!1,(!t.PlannedStartDate||moment().isAfter(t.PlannedStartDate))&&(t.highlight=!0),t.Ready||(t.highlight=!0),t.PreliminaryEstimate||(t.highlight=!0),t.DirectChildrenCount||(t.highlight=!0),t.ActualStartDate||(t.highlight=!0),i&&e.filter.hlsCOMMON(t,r)},e.filter.hlsDone=function(t,r){var i=!1;return t.State&&"Completed"===t.State.Name&&(i=!0),t.highlight=!1,(!t.PlannedStartDate||moment().isAfter(t.PlannedStartDate))&&(t.highlight=!0),t.Ready||(t.highlight=!0),t.PreliminaryEstimate||(t.highlight=!0),t.DirectChildrenCount||(t.highlight=!0),t.ActualStartDate||(t.highlight=!0),i&&e.filter.hlsCOMMON(t,r)},e.filter.epicCommon=function(e,t){return e&&t&&e.Project?e.Project._refObjectName!==t._refObjectName?!1:!0:!1},e.filter.epicDefinitionIP=function(t,r){var i=!1;return null!==t.State&&"Definition - In Progress"===t.State.Name&&(i=!0),t.highlight=!1,t.Ready===!0&&(t.highlight=!0),t.DirectChildrenCount>0&&(t.highlight=!0),i&&e.filter.epicCommon(t,r)},e.filter.epicDefinitionCompleted=function(t,r){var i=!1;return null!==t.State&&"Definition - Completed"===t.State.Name&&(i=!0),t.highlight=!1,t.Ready!==!0&&(t.highlight=!0),t.DirectChildrenCount>0&&(t.highlight=!0),i&&e.filter.epicCommon(t,r)},e.filter.epicDeliveryIP=function(t,r){var i=!1;return null!==t.State&&"Delivery - In Progress"===t.State.Name&&(i=!0),t.highlight=!1,0===t.DirectChildrenCount&&(t.highlight=!0),i&&e.filter.epicCommon(t,r)},e.filter.epicDeliveryCompleted=function(t,r){var i=!1;return null!==t.State&&"Delivery - Completed"===t.State.Name&&(i=!0),t.highlight=!1,0===t.DirectChildrenCount&&(t.highlight=!0),i&&e.filter.epicCommon(t,r)},e.filter.storyDefinitionCOMMON=function(t,r){return t&&r&&t.Project?t.Project._refObjectName!=r._refObjectName?!1:null!==t.Iteration&&(_.contains(e.sprint[0],t.Iteration._refObjectName)||_.contains(e.sprint[1],t.Iteration._refObjectName))?!1:!0:!1},e.filter.storyDefinitionIP=function(t,r){return"Backlog"!==t.ScheduleState?!1:e.filter.storyDefinitionCOMMON(t,r)},e.filter.storyDefinitionDone=function(t,r){return"Defined"!==t.ScheduleState?!1:(t.highlight=!0,t.Tags.Count>0?t.highlight=!1:1==t.Ready?t.highlight=!1:t.PlanEstimate>0&&(t.highlight=!1),e.filter.storyDefinitionCOMMON(t,r))},e.filter.storyRPCOMMON=function(e,t){return e&&t&&e.Project?e.Project._refObjectName!=t._refObjectName?!1:(e.highlight=!0,e.Tags.Count>0?e.highlight=!1:1==e.Ready?e.highlight=!1:e.PlanEstimate>0&&(e.highlight=!1),!0):!1},e.filter.storyRPS2=function(t,r){return t.Iteration&&_.contains(e.sprint[2],t.Iteration._refObjectName)?e.filter.storyRPCOMMON(t,r):!1},e.filter.storyRPS1=function(t,r){return t.Iteration&&_.contains(e.sprint[1],t.Iteration._refObjectName)?e.filter.storyRPCOMMON(t,r):!1},e.filter.deliveryCOMMON=function(t,r){return t&&r&&t.Project&&t.Iteration&&_.contains(e.sprint[0],t.Iteration._refObjectName)?t.Project._refObjectName!=r._refObjectName||null===t.track?!1:(t.highlight=!1,0===t.PlanEstimate?t.highlight=!0:0==t.Ready?t.highlight=!0:t.Tags&&0!==t.Tags.Count||(t.highlight=!0),!0):!1},e.filter.deliveryBacklog=function(t,r){var i=!1;return _.contains(["In-Progress","Completed","Accepted"],t.ScheduleState)||(i=!0),i&&e.filter.deliveryCOMMON(t,r)},e.filter.deliveryInProgress=function(t,r){var i=!1;return"In-Progress"===t.ScheduleState&&(i=!0),i&&e.filter.deliveryCOMMON(t,r)},e.filter.deliveryCompleted=function(t,r){var i=!1;return"Completed"===t.ScheduleState&&(i=!0),i&&e.filter.deliveryCOMMON(t,r)},e.filter.deliveryAccepted=function(t,r){var i=!1;return"Accepted"===t.ScheduleState&&(i=!0),i&&e.filter.deliveryCOMMON(t,r)}},e.init()}]);