var templates={template1:Handlebars.compile(document.getElementById("item-template").innerHTML),template2:Handlebars.compile(document.getElementById("release-template").innerHTML),point:Handlebars.compile(document.getElementById("point").innerHTML),hlsTemplate:Handlebars.compile(document.getElementById("hls-template").innerHTML)},apikey="_Tgxq2pPzSNSlrvt2fapH0YW1bc5okjFhvj5ortDJas",myApp=angular.module("pmoReport",[]);myApp.config(function(e){e.startSymbol("(("),e.endSymbol("))")}),myApp.controller("MainCtrl",["$scope","$http","$q","$anchorScroll","$location",function(e,t,r,a,n){s=e,e.queryArtifactsAndStore=function(a,n,o){if(!o)var o=r.defer();var i=n||1,l="https://rally1.rallydev.com/slm/webservice/v2.0/"+a,s={params:{workspace:"https://rally1.rallydev.com/slm/webservice/v2.0/workspace/19718879730",query:"",fetch:!0,start:i,pagesize:200,project:"https://rally1.rallydev.com/slm/webservice/v2.0/project/25211977995",projectScopeDown:!0,projectScopeUp:!1,key:"ae437b95-d241-4320-ad81-bd0681947c89"},headers:{zsessionid:apikey}};return t.get(l,s).success(function(t,r,i,l){if(t.QueryResult.Results.length==l.params.pagesize)e.loadingProgress+=Math.floor(60*(l.params.pagesize/t.QueryResult.TotalResultCount)),e.queryArtifactsAndStore(a,(n||0)+l.params.pagesize,o);else{var s=t;o.resolve(s)}}).error(function(t,r,a,n){return e.loadingScreenDetails.push("[Error] : Loading Data Failed"),o.reject()}),o.promise},e.init=function(){r.all([e.queryArtifactsAndStore("release"),e.queryArtifactsAndStore("PortfolioItem/Epic"),e.queryArtifactsAndStore("PortfolioItem/HighLevelScope"),e.queryArtifactsAndStore("iteration")]).then(function(t){e.releases=t[0].QueryResult.Results,e.releasesFiltered=o(e.releases),e.epicData=t[1].QueryResult.Results,e.hlsData=t[2].QueryResult.Results,e.iterationData=t[3].QueryResult.Results,e.buildTimeline()},function(e){})},e.RL=[],e.buildTimeline=function(){var t=e.epicToTimelineFormat(e.epicData);e.data=t[0];for(var r=_.uniq(e.data,"group"),a=[],n=[],o=0;o<r.length;o++)a.push({id:r[o].group,content:r[o].hlsName,subgroupOrder:function(e,t){return e.subgroupOrder-t.subgroupOrder}});for(var l=0;l<e.data.length;l++){var s=e.data[l],m=_.findIndex(n,{content:s.hlsRealName});if(-1===m)n.push({content:s.hlsRealName,start:s.start,end:s.end,group:s.group,template:"hlsTemplate",style:"background-color: rgba(24, 51, 163, 0.83); color: white; border-width:0; height:27px",subgroupOrder:0,subgroup:"hls"});else{var p=n[m];moment(s.start).isBefore(p.start)&&(p.start=s.start),moment(s.end).isBefore(p.end)&&(p.end=s.end)}}e.hlsItemArray=n,a.push({id:0,content:"Sprints"});for(var c=new vis.DataSet(a),o=0;o<e.iterationData.length;o++){var u=e.iterationData[o].Name,d=u.split(" ");if(d&&"ELA"===d[0].toUpperCase()){var f=u.match(/\d+$/)[0];e.data.push({content:"Sprint "+f,start:moment(e.iterationData[o].StartDate).format("YYYY-MM-DD"),end:moment(e.iterationData[o].EndDate).format("YYYY-MM-DD"),group:0,template:"template2",style:"background-color: rgba(61, 63, 71, 0.85); color: white; border-width:0; height:27px"})}}e.data=n.concat(e.data,t[1]);var h=document.getElementById("visualization"),g=new vis.DataSet(e.data),D={zoomable:!1,moveable:!0,editable:!1,selectable:!1,template:function(e){if(!e.template)return null;var t=templates[e.template];return t(e)},groupOrder:function(e,t){return e.id-t.id},orientation:"top",stack:!1};e.timeline=new vis.Timeline(h,g,D);for(var o=0;o<e.releasesFiltered.length;o++){var v=e.timeline.addCustomTime(moment(e.releasesFiltered[o].ReleaseDate).format("YYYY-MM-DD"),"releaseline"+(o+1));e.RL.push({id:v,correctTime:e.timeline.getCustomTime(v)})}e.timeline.setGroups(c),e.timeline.fit(),i(),e.timeline.on("timechanged",function(t){var r=t.id,a=_.where(e.RL,{id:r})[0];e.timeline.setCustomTime(a.correctTime,r)})};var o=function(e){var t=[];return t=_.filter(e,function(e){return!0}),t=_.uniq(t,"Name"),t=_.sortBy(t,"ReleaseDate")};e.epicToTimelineFormat=function(t){var r=[],a=[];return angular.forEach(t,function(t,n){if(t.PlannedStartDate&&t.PlannedEndDate&&t.Release&&t.Parent){var o=_.where(e.hlsData,{_refObjectUUID:t.Parent._refObjectUUID})[0];r.push({id:n,name:t.Name,content:t.FormattedID,hlsName:o.FormattedID,hlsRealName:o.Name,detailLink:l(t),start:moment(t.PlannedStartDate).format("YYYY-MM-DD"),end:moment(t.PlannedEndDate).format("YYYY-MM-DD"),percentDone:parseInt(100*t.PercentDoneByStoryCount),percentIncomplete:100-parseInt(100*t.PercentDoneByStoryCount),committed:50,planned:40,accepted:10,group:t.Parent._refObjectUUID,subgroup:t.FormattedID.substr(4),subgroupOrder:1,template:"template1",style:"height:60px; border-width:0;"});var i=_.where(e.releases,{_refObjectUUID:t.Release._refObjectUUID})[0];a.push({content:i.Name,id:"release"+n,type:"point",group:t.Parent._refObjectUUID,start:i?moment(i.ReleaseDate).format("YYYY-MM-DD"):null,template:"point"})}}),[r,a]};var i=function(){for(var t=0;t<e.releasesFiltered.length;t++){var r="Time: "+moment(e.timeline.getCustomTime("releaseline"+(t+1))).format("dddd, MMMM Do YYYY")+", 0:00:00",a=e.releasesFiltered[t].Name.split(" "),n=a[1];_.contains(a,"ERMO")&&($(".customtime[title='"+r+"']").addClass("quarterlyRelease"),$(".customtime[title='"+r+"']").prepend("<span>&nbsp;&nbsp;<strong>"+n+"</strong></span>"))}},l=function(e){var t="https://us1.rallydev.com/#/",r=e._type,a=e.ObjectID,n=e.Project._ref.split("/"),o=n[n.length-1],i="";return i="PortfolioItem/HighLevelScope"===r?"/detail/portfolioitem/highlevelscope/"+a:"PortfolioItem/Epic"===r?"/detail/portfolioitem/epic/"+a:"/detail/userstory/"+a,t+o+i};e.init()}]),myApp.directive("hlsTicket",function(){return{templateUrl:"ticket.html"}});